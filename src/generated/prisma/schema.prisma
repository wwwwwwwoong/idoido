// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Enums
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum ResultChoice {
  SUCCESS
  SILLY
  NEXT
}

enum CurrencyType {
  WATER_DROP // ğŸ’§ ë¬¼ë°©ìš¸ (ë¬´ë£Œ)
  MAGIC_SEED // ğŸŒ± ë§ˆë²•ì˜ì”¨ì•— (ìœ ë£Œ/íŠ¹ë³„ë³´ìƒ)
}

enum BookStatus {
  DRAFT // ì‘ì„± ì¤‘
  COMPLETED // ì™„ì„±ë¨
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// User Profile
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Profile {
  /// Supabase auth.users.id (UUID)
  id        String   @id @db.Uuid
  createdAt DateTime @default(now())

  // ì¬í™” ì”ì•¡ (ìºì‹œ, ì‹¤ì œ ë‚´ì—­ì€ WalletLedgerì—)
  waterDrops Int @default(0)
  magicSeeds Int @default(0)

  characters   Character[]
  scenes       Scene[]
  walletLedger WalletLedger[]
  books        Book[]
  cards        Card[]

  // ë ˆê±°ì‹œ (ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì‚­ì œ ê°€ëŠ¥)
  seedLedger SeedLedger[]
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Wallet System (ì´ì¤‘ ì¬í™”)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model WalletLedger {
  id           String       @id @default(uuid()) @db.Uuid
  userId       String       @db.Uuid
  currencyType CurrencyType
  delta        Int // ì–‘ìˆ˜: íšë“, ìŒìˆ˜: ì‚¬ìš©
  reason       String // ì˜ˆ: "daily_login", "scene_created", "purchase"
  createdAt    DateTime     @default(now())

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, currencyType, createdAt])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Character
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Character {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid

  name    String?
  styleId String? // AI ìŠ¤íƒ€ì¼ ID (ì˜ˆ: "watercolor", "clay")

  // ìºë¦­í„° í”„ë¡œí•„
  role        String? // "hero" = ì£¼ì¸ê³µ, "helper" = ë„ìš°ë¯¸, "other"
  personality String? // ì„±ê²© (ì˜ˆ: "brave", "shy", "playful")
  likes       String[] // ì¢‹ì•„í•˜ëŠ” ê²ƒ ë°°ì—´

  doodlePath String // ì›ë³¸ ë‚™ì„œ/ì‚¬ì§„ ê²½ë¡œ
  renderPath String? // AI ë³€í™˜ í›„ ê²½ë¡œ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  scenes Scene[]

  @@index([userId, createdAt])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Scene (ì¥ë©´)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Scene {
  id          String  @id @default(uuid()) @db.Uuid
  userId      String  @db.Uuid
  characterId String? @db.Uuid // nullable - ìºë¦­í„° ì‚­ì œí•´ë„ ì¥ë©´ ìœ ì§€
  bookId      String? @db.Uuid // ë™í™”ì±…ì— ì†í•œ ê²½ìš°

  backgroundId String
  itemId       String
  verbId       String
  resultChoice ResultChoice

  storyText      String? // AI ìƒì„± ìŠ¤í† ë¦¬ í…ìŠ¤íŠ¸ (í•œêµ­ì–´)
  sceneImagePath String? // í•©ì„± ì´ë¯¸ì§€ ê²½ë¡œ

  order Int? // ë™í™”ì±… ë‚´ ìˆœì„œ

  // === ì‹ ê·œ í•„ë“œ (MVP) ===
  textEn         String? // ì˜ì–´ ë²„ì „
  beatType       String? // SETUP/INCITING/TRY_FAIL/TURN/CLIMAX/RESOLUTION
  sceneHint      String? // ì´ë¯¸ì§€ìš© ì¥ë©´ íŒíŠ¸
  learningTags   Json? // {keywords[], emotion, pattern}
  layoutTemplate String? // T1~T6 í…œí”Œë¦¿ ID
  objects        Json? // [New] ì¥ë©´ ë‚´ ì˜¤ë¸Œì íŠ¸ ë°°ì¹˜ ì •ë³´ (SceneObject[])
  audioUrl       String? // [New] TTS ì˜¤ë””ì˜¤ íŒŒì¼ ê²½ë¡œ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      Profile    @relation(fields: [userId], references: [id], onDelete: Cascade)
  character Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)
  book      Book?      @relation(fields: [bookId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([characterId, createdAt])
  @@index([bookId, order])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Book (ë™í™”ì±…)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Book {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid

  title     String? // ë™í™”ì±… ì œëª©
  coverPath String? // í‘œì§€ ì´ë¯¸ì§€ ê²½ë¡œ
  status    BookStatus @default(DRAFT)

  // êµìœ¡ì  ì½˜í…ì¸  (ê¸°ì¡´)
  topicId          String? // ì„ íƒí•œ ì£¼ì œ ID (ì˜ˆ: anger, sharing, courage)
  lesson           String? // ë°°ìš¸ êµí›ˆ
  targetSceneCount Int     @default(7) // ëª©í‘œ ì¥ë©´ ìˆ˜ (5/7/10)
  outline          Json? // ìŠ¤í† ë¦¬ ë¼ˆëŒ€ (SceneGuide[])

  // === Setup (ì‹ ê·œ) ===
  pageLength Int    @default(8) // 8/12/16
  language   String @default("ko") // ko/en/both
  ageRange   String @default("4-7")

  // === Mixer - ì†Œì¬ ì„ íƒ (ì‹ ê·œ) ===
  mixerTale    String? // ì „ë˜ (ì˜ˆ: "korean_traditional", "world_folktale")
  mixerCulture String? // ë¬¸í™” (ì˜ˆ: "seollal", "chuseok", "hanbok")
  mixerSetting String? // ë°°ê²½ (ì˜ˆ: "village", "forest", "palace")
  mixerTone    String? // í†¤ (ì˜ˆ: "warm", "adventurous", "funny")
  mixerPack    String? // í•™ìŠµíŒ© (ì˜ˆ: "emotions", "manners", "nature")

  // === Story Bible (ì‹ ê·œ) ===
  storyBible Json? // {tone, lesson, setting, avoid[]}
  storyChars Json? // [{name, role, traits[]}] - characters
  storyObjs  Json? // [í•µì‹¬ ì†Œì¬ ë¦¬ìŠ¤íŠ¸]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime? // ì™„ì„± ì‹œì 

  user   Profile       @relation(fields: [userId], references: [id], onDelete: Cascade)
  scenes Scene[]
  seeds  ProjectSeed[]
  cards  Card[]

  @@index([userId, status, createdAt])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Project Seed (ì•„ì´ê°€ ì—…ë¡œë“œí•œ ê·¸ë¦¼)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model ProjectSeed {
  id        String   @id @default(uuid()) @db.Uuid
  bookId    String   @db.Uuid
  imageUrl  String
  seedType  String // CHARACTER/OBJECT/LOCATION/DOODLE
  audioUrl  String?
  createdAt DateTime @default(now())

  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model Card {
  id     String  @id @default(uuid()) @db.Uuid
  userId String  @db.Uuid
  bookId String? @db.Uuid

  type  String // e.g., "ì˜ˆìˆ ", "ì •ì„œ", "ì–¸ì–´"
  name  String // e.g., "ë‚˜ë§Œì˜ ìºë¦­í„°", "ìš©ê¸°"
  desc  String? // e.g., "ì„¸ìƒì— í•˜ë‚˜ë¿ì¸ ì£¼ì¸ê³µ"
  color String? // UIìš© ìƒ‰ìƒ ì½”ë“œ

  imagePath String? // Optional image

  createdAt DateTime @default(now())

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book?   @relation(fields: [bookId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GenerationJob (ìƒì„± ì‘ì—… ì¶”ì  + í™˜ê¸‰)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model GenerationJob {
  id      String  @id @default(uuid()) @db.Uuid
  userId  String  @db.Uuid
  bookId  String? @db.Uuid
  jobType String // story/text/image
  status  String  @default("pending") // pending/running/done/failed

  inputData  Json
  outputData Json?
  costType   String // drops/seeds
  costAmount Int
  refunded   Boolean @default(false)

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId, status])
  @@index([bookId])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Legacy (ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì‚­ì œ ì˜ˆì •)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model SeedLedger {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  delta     Int
  reason    String
  createdAt DateTime @default(now())

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}
